# 蓝牙连接功能使用指南

## 功能概述

本小程序支持通过蓝牙连接车辆，实现近距离控制功能，包括：
- 蓝牙扫描和连接车辆
- 通过蓝牙启动/停止车辆
- 通过蓝牙解锁/锁定车辆
- 通过蓝牙寻车

## 使用步骤

### 1. 打开蓝牙连接页面

- 方式1：首页 -> 功能 -> 蓝牙连接
- 方式2：车辆控制页面 -> 蓝牙连接按钮

### 2. 扫描设备

1. 点击"开始扫描"按钮
2. 确保车辆蓝牙已开启
3. 确保车辆在附近（建议10米内）
4. 等待扫描到设备

### 3. 连接设备

1. 在设备列表中找到您的车辆
2. 点击设备项进行连接
3. 等待连接成功提示

### 4. 使用蓝牙控制

连接成功后，在车辆控制页面：
- 启动/停止按钮会自动使用蓝牙控制
- 显示"蓝牙已连接"状态
- 可以近距离控制车辆

## 技术说明

### 蓝牙协议

当前实现使用JSON格式的指令：

```json
{
  "cmd": "START",  // 指令类型
  "timestamp": 1234567890
}
```

支持的指令：
- `START` - 启动车辆
- `STOP` - 停止车辆
- `UNLOCK` - 解锁
- `LOCK` - 锁定
- `FIND` - 寻车
- `STATUS` - 查询状态

### 服务UUID配置

实际使用时，需要根据车辆的实际蓝牙服务UUID进行配置：

1. 编辑 `utils/bluetooth.js`
2. 在 `isTargetDevice` 方法中配置服务UUID
3. 或编辑 `services/bluetooth.js` 中的 `scanVehicles` 方法

示例：
```javascript
const scanOptions = {
  serviceUUIDs: ['0000FFE0-0000-1000-8000-00805F9B34FB'] // 替换为实际UUID
};
```

### 特征值配置

连接设备后，系统会自动查找可写的特征值。如果车辆使用特定的特征值UUID，可以在 `getCharacteristics` 方法中指定。

## 权限配置

在 `app.json` 中已配置蓝牙权限：

```json
"permission": {
  "scope.bluetooth": {
    "desc": "需要蓝牙权限以连接和控制车辆"
  }
}
```

## 注意事项

1. **蓝牙范围**：蓝牙控制需要在车辆附近（通常10米内）
2. **网络控制**：未连接蓝牙时，自动使用网络控制
3. **连接状态**：页面会自动检测蓝牙连接状态
4. **设备名称**：默认扫描包含"首驱"的设备，可在代码中修改
5. **服务UUID**：需要根据实际车辆配置服务UUID

## 故障排查

### 问题1：扫描不到设备
- 检查车辆蓝牙是否开启
- 检查车辆是否在附近
- 检查小程序蓝牙权限是否授权
- 尝试刷新设备列表

### 问题2：连接失败
- 检查设备是否已被其他设备连接
- 检查车辆蓝牙是否正常
- 尝试重新扫描并连接

### 问题3：控制无响应
- 检查蓝牙连接状态
- 检查车辆是否在线
- 查看控制台错误信息
- 确认指令格式是否正确

## 开发说明

### 修改设备过滤条件

编辑 `services/bluetooth.js`：

```javascript
const scanOptions = {
  deviceName: '首驱', // 修改为实际设备名称
  serviceUUIDs: [] // 添加服务UUID
};
```

### 修改指令格式

编辑 `services/bluetooth.js` 中的指令生成部分：

```javascript
const command = JSON.stringify({
  cmd: COMMANDS.START,
  timestamp: Date.now(),
  // 添加其他参数
});
```

### 添加新指令

1. 在 `COMMANDS` 对象中添加新指令
2. 在 `services/bluetooth.js` 中添加对应的函数
3. 在页面中调用新函数

## 安全提示

1. 蓝牙控制仅在近距离有效，相对安全
2. 建议添加身份验证机制
3. 建议对指令进行加密
4. 建议添加操作日志
