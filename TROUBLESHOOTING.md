# 故障排查指南

## 选择目的地失败问题

### 常见原因和解决方案

#### 1. 位置权限未授权

**症状**：点击选择目的地后立即报错"选择目的地失败"

**解决方案**：
- 检查 `app.json` 中是否配置了位置权限
- 在微信开发者工具中：设置 -> 项目设置 -> 不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书
- 真机调试时，需要在手机设置中授权位置权限

**检查代码**：
```javascript
// app.json 中应该有
"permission": {
  "scope.userLocation": {
    "desc": "您的位置信息将用于车辆定位和导航功能"
  }
}
```

#### 2. 用户拒绝了位置权限

**症状**：第一次调用时弹出权限请求，用户点击拒绝后，后续调用都失败

**解决方案**：
- 代码已添加权限检查和引导开启功能
- 如果用户拒绝，会弹出提示引导用户去设置中开启

#### 3. 微信版本过低

**症状**：`wx.chooseLocation` API 不支持

**解决方案**：
- 确保微信版本 >= 7.0.0
- 检查基础库版本 >= 2.0.0

#### 4. 网络问题

**症状**：选择地点时地图加载失败

**解决方案**：
- 检查网络连接
- 检查是否配置了合法域名（开发环境可关闭校验）

### 调试方法

#### 方法1：查看控制台错误

在 `chooseDestination` 方法中添加详细日志：

```javascript
catch (error) {
  console.error('选择目的地错误详情:', error);
  console.error('错误类型:', typeof error);
  console.error('错误消息:', error.errMsg);
  console.error('完整错误对象:', JSON.stringify(error));
}
```

#### 方法2：检查权限状态

在调用前检查权限：

```javascript
wx.getSetting({
  success: (res) => {
    console.log('位置权限状态:', res.authSetting['scope.userLocation']);
  }
});
```

#### 方法3：测试 chooseLocation API

直接测试 API 是否可用：

```javascript
wx.chooseLocation({
  success: (res) => {
    console.log('选择成功:', res);
  },
  fail: (error) => {
    console.error('选择失败:', error);
  }
});
```

### 改进后的错误处理

已添加以下改进：

1. **权限检查**：调用前先检查权限状态
2. **详细错误信息**：显示具体的错误原因
3. **权限引导**：用户拒绝权限时引导开启
4. **错误日志**：控制台输出详细错误信息

### 常见错误码

- `auth deny` - 用户拒绝了权限
- `system permission denied` - 系统权限被拒绝
- `fail cancel` - 用户取消操作（正常情况，不报错）
- `fail` - 其他失败原因

### 测试步骤

1. **清除权限**：
   - 微信 -> 设置 -> 隐私 -> 授权管理
   - 找到小程序，清除位置权限

2. **重新测试**：
   - 打开小程序
   - 进入导航页面
   - 点击选择目的地
   - 观察是否弹出权限请求

3. **查看日志**：
   - 打开微信开发者工具控制台
   - 查看详细错误信息

### 如果问题仍然存在

1. 检查微信版本和基础库版本
2. 检查 `app.json` 配置
3. 查看控制台完整错误信息
4. 尝试在真机上测试（模拟器可能有限制）
