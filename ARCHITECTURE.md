# 架构设计文档

## 一、整体架构

本项目采用分层架构设计，将业务逻辑、数据管理、UI展示进行清晰分离，确保代码的可维护性和可扩展性。

```
┌─────────────────────────────────────┐
│         页面层 (Pages)              │
│   UI展示 + 用户交互                 │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│        服务层 (Services)             │
│   API调用 + 业务逻辑封装             │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│      状态管理层 (Stores)             │
│   全局状态管理 + 数据缓存            │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│        工具层 (Utils)                │
│   通用工具函数 + 基础能力             │
└─────────────────────────────────────┘
```

## 二、核心模块设计

### 1. 工具层 (Utils)

#### 1.1 网络请求模块 (utils/request.js)
**职责**：统一处理所有HTTP请求

**特性**：
- 请求拦截器：自动添加token、通用header
- 响应拦截器：统一错误处理、状态码处理
- 支持GET、POST、PUT、DELETE方法
- 自动处理401未授权，跳转登录
- 请求日志记录

**使用示例**：
```javascript
import { get, post } from '../../utils/request';
const data = await get('/api/vehicle/list');
```

#### 1.2 本地存储模块 (utils/storage.js)
**职责**：封装微信小程序本地存储API

**特性**：
- 统一的存储接口
- 支持token、用户信息、车辆信息等专用方法
- 错误处理

#### 1.3 日志系统 (utils/logger.js)
**职责**：统一日志管理

**特性**：
- 支持DEBUG、INFO、WARN、ERROR级别
- 日志缓存（最多100条）
- 错误自动上报（可扩展）

#### 1.4 UI工具 (utils/ui.js)
**职责**：封装常用UI操作

**特性**：
- Toast提示
- Loading加载
- Modal对话框
- 页面导航

#### 1.5 格式化工具 (utils/format.js)
**职责**：数据格式化

**特性**：
- 日期格式化
- 距离、速度、电量格式化
- 时长格式化

### 2. 服务层 (Services)

#### 2.1 车辆服务 (services/vehicle.js)
**职责**：车辆相关API调用

**主要方法**：
- `getVehicleList()` - 获取车辆列表
- `getVehicleStatus()` - 获取车辆状态
- `unlockVehicle()` - 解锁车辆
- `lockVehicle()` - 锁定车辆
- `findVehicle()` - 寻车
- `updateVehicleSettings()` - 更新车辆设置

#### 2.2 行程服务 (services/trip.js)
**职责**：行程相关API调用

**主要方法**：
- `getTripList()` - 获取行程列表
- `getTripDetail()` - 获取行程详情
- `getTripStatistics()` - 获取行程统计

#### 2.3 电池服务 (services/battery.js)
**职责**：电池相关API调用

**主要方法**：
- `getBatteryInfo()` - 获取电池信息
- `getBatteryHealth()` - 获取电池健康度

#### 2.4 用户服务 (services/user.js)
**职责**：用户相关API调用

**主要方法**：
- `login()` - 用户登录
- `getUserInfo()` - 获取用户信息
- `updateUserInfo()` - 更新用户信息

### 3. 状态管理层 (Stores)

#### 3.1 基础Store (stores/index.js)
**职责**：提供状态管理基础能力

**特性**：
- 状态存储
- 状态订阅/通知机制
- 观察者模式实现

#### 3.2 车辆Store (stores/vehicle.js)
**职责**：管理车辆相关状态

**状态**：
- `vehicleList` - 车辆列表
- `currentVehicle` - 当前车辆
- `vehicleStatus` - 车辆状态
- `isConnected` - 连接状态
- `isOnline` - 在线状态

**主要方法**：
- `initConnection()` - 初始化连接
- `connectVehicle()` - 连接车辆
- `getVehicleStatus()` - 获取状态
- `startStatusPolling()` - 开始状态轮询
- `unlockVehicle()` - 解锁车辆

**状态轮询机制**：
- 连接成功后自动开始轮询
- 每5秒更新一次状态
- 页面卸载时自动停止

#### 3.3 用户Store (stores/user.js)
**职责**：管理用户相关状态

**状态**：
- `userInfo` - 用户信息
- `isLoggedIn` - 登录状态

**主要方法**：
- `getUserInfo()` - 获取用户信息
- `login()` - 用户登录
- `logout()` - 退出登录

### 4. 页面层 (Pages)

#### 4.1 首页 (pages/index/index)
**功能**：
- 显示车辆基本信息（电量、续航、速度等）
- 快速操作（解锁/锁定、寻车、控制）
- 功能入口导航

#### 4.2 车辆控制 (pages/vehicle/control)
**功能**：
- 远程解锁/锁定
- 远程启动/停止
- 寻车功能
- 跳转车辆设置

#### 4.3 车辆状态 (pages/vehicle/status)
**功能**：
- 实时显示车辆状态
- 电量信息
- 行驶信息
- 位置信息
- 其他信息（温度、信号等）

#### 4.4 寻车 (pages/vehicle/find)
**功能**：
- 显示车辆位置地图
- 寻车功能（鸣笛+闪灯）
- 打开地图导航

#### 4.5 行程记录 (pages/trip/record)
**功能**：
- 显示行程列表
- 行程统计
- 行程详情查看

#### 4.6 车辆设置 (pages/settings/vehicle)
**功能**：
- 大灯设置（开关、亮度）
- 定速巡航设置（开关、速度）
- 坐垫感应设置

#### 4.7 电池管理 (pages/battery/battery)
**功能**：
- 电池状态显示
- 电池详细信息
- 电池健康度
- 使用提示

## 三、数据流设计

### 1. 状态更新流程
```
用户操作 
  → 页面调用Store方法 
    → Store调用Service 
      → Service调用API 
        → 更新Store状态 
          → 通知订阅者 
            → 页面更新UI
```

### 2. 状态轮询机制
```
连接车辆 
  → 启动轮询定时器 
    → 每5秒调用API获取状态 
      → 更新Store 
        → 通知页面更新
```

## 四、错误处理策略

### 1. 网络错误
- 统一在request.js中处理
- 401自动跳转登录
- 500显示服务器错误提示
- 其他错误显示网络错误提示

### 2. 业务错误
- 根据错误码显示不同提示
- 记录错误日志
- 关键错误上报服务器

### 3. 异常捕获
- 页面onError捕获全局错误
- 关键操作使用try-catch
- 异步操作统一错误处理

## 五、性能优化

### 1. 状态管理优化
- 使用单例模式避免重复创建
- 状态更新使用浅比较
- 按需订阅状态变化

### 2. 网络请求优化
- 请求去重
- 请求缓存（可扩展）
- 请求超时控制

### 3. 页面优化
- 按需加载数据
- 列表虚拟滚动（可扩展）
- 图片懒加载（可扩展）

## 六、扩展性设计

### 1. 插件化
- 工具函数可独立使用
- 服务层可独立替换
- Store可独立扩展

### 2. 配置化
- API地址可配置
- 轮询间隔可配置
- 错误处理策略可配置

### 3. 模块化
- 功能模块独立
- 页面组件可复用
- 样式统一管理

## 七、安全考虑

### 1. 数据安全
- Token存储在本地存储
- 敏感信息加密（可扩展）
- API请求签名（可扩展）

### 2. 权限控制
- 页面级权限控制
- 功能级权限控制
- API级权限验证

## 八、测试策略

### 1. 单元测试
- 工具函数测试
- 服务层测试
- Store测试

### 2. 集成测试
- 页面流程测试
- API集成测试

### 3. 端到端测试
- 完整用户流程测试

## 九、部署与运维

### 1. 构建
- 代码压缩
- 资源优化
- 版本管理

### 2. 监控
- 错误监控
- 性能监控
- 用户行为分析

### 3. 更新
- 小程序自动更新检查
- 版本兼容性处理
